
# 動画ダウンロードアプリ 仕様書（完全版）

## 1. アプリコンセプト

- 名前：Fetchy
- 思想：共有画面から即ダウンロード、Quick Lookで閲覧。ユーザー体験を壊さず、全て共有画面内で完結。
- 本体アプリは設定・履歴確認がメイン。
- yt-dlp バンドル済みで、YouTube・TikTok・X（添付動画付きポスト）などのURLを取得可能。

## 2. Share Extension（共有画面）

### 2.1 初期表示
- 表示内容：サービス名 / タイトル、ステータステキスト（解析中/取得中/統合中）
- ボタン：「プログレス表示 ▶︎」（ユーザータップでバー表示）
- 振動・画面ロック：2%進捗ごとに微振動（設定でON/OFF・強度変更）、画面ロック防止

### 2.2 プログレス表示（ユーザータップ時）
- 進捗バー（0〜100%）、パーセンテージ表示、状態テキスト更新
- 微振動 2%ごとに発火（設定可）

### 2.3 トースト通知（経過時間ベース）
- 表示タイミング設定可能
  - 5分経過：「ダウンロードが長く続いています。長時間経過すると、OSにより中断される可能性があります」
  - 8分経過：「まだダウンロード中です。OSにより中断される可能性があります」
- ユーザー操作や動画長さには依存しない
- 脅し表現はなし

### 2.4 Quick Look
- 閲覧専用、保存・共有はQuick Look標準UIに任せる
- 閉じると temp ファイル即削除

### 2.5 エラー・中断
- ユーザー閉じ → kill & temp削除
- OS kill → 無言終了
- yt-dlp エラー → トースト表示：「取得に失敗しました。詳細は本体アプリで確認できます」

## 3. 本体アプリ

### 3.1 タブ構成（TabView）
TabView
├─ 履歴タブ
├─ 設定タブ
└─ ダウンロードタブ

### 3.2 履歴タブ
- 最新URL・タイトル・サービスアイコン表示
- 20件ずつロード、スクロールで追加取得
- 各項目タップで簡易ログ表示（詳細ログは別画面）

### 3.3 設定タブの一部
| 設定項目 | 内容 | デフォルト |
|-----------|------|-----------|
| 微振動 | ON/OFF | ON |
| 微振動強度 | light / medium / heavy | light |
| プログレスバー初期表示 | ON/OFF | OFF |
| トースト通知 | ON/OFF | ON |
| トースト表示タイミング | 分単位 | 5,8 |
| デフォルト解像度 | リスト or 数字入力 | 1080p |
| デフォルト音声品質 | 44.1k / 48k / 96k / ロスレス | 44.1k |

### 3.4 ダウンロードタブ
- URL入力欄兼確定ボタン(キーボードのEnterが確定ボタンになってるやつ)
- プログレスバー・状態テキスト等（Share Extension同等）

## 4. 履歴・ログ

### 4.1 履歴画面
- タイトル左にサービスアイコン（SVG / アセットカラー）
- 20件ずつロード、スクロールで次20件取得
- 履歴削除期間はiOS標準日時選択キット

### 4.2 詳細履歴・ログ画面
- テーブル形式で全ログ表示
- ページング：20件ずつ
- 簡易履歴から「ログ参照」可能

### 4.3 DB設計
- SQLite直書き（FMDB / GRDB）
- インデックス：created_at / service / status
- App Group ディレクトリ構成：
AppGroup/
├─ db/
│  └─ main.sqlite
├─ logs/
│  ├─ yyyy-mm/
│  │  └─ log_<uuid>.zst
├─ temp/
│  └─ session_<uuid>/
│     └─ video.mp4
- temp/session は Quick Look 閉じたら即削除
- ログは圧縮して高速アクセス

## 5. yt-dlp 実行管理
- バンドル済み・署名済み
- 非同期 Process + Pipe で stdout/stderr 監視
- プログレスバー更新用に進捗解析
- エラー時はトースト表示のみ
- ユーザー閉じで kill、OS kill は無言終了
- stdout停止で無反応判定も可
- クオリティ選択：解像度（リスト or 数字入力）、音声品質（44.1k / 48k / 96k / ロスレス）
- ダウンロード失敗時はトースト通知後、規定クオリティで再DL

## 6. Share Extension 状態マシン
Share Extension State
├─ started      → yt-dlp 起動
├─ downloading  → ダウンロード中
├─ preview_ready → Quick Look表示可能
├─ completed    → 正常終了
├─ cancelled    → ユーザー閉じ / temp削除
├─ failed       → エラー発生
└─ aborted_by_system → OS kill

## 7. UXポイント
- 押し付けないUI：デフォルトはテキストのみ
- ユーザー意思重視：プログレスバー表示・振動ON/OFFはユーザー主導
- 長時間対応：画面ロック防止、10分前後の動画でも継続可
- Quick Look優先：閲覧・共有はQuick Look標準UIで完結
- 中断情報は事実のみ：トーストでOS killの可能性のみ

## 8. Share Extension・本体アプリ 画面ツリー
App
├─ TabView
│  ├─ 履歴タブ
│  │  ├─ 履歴リスト（20件ずつロード）
│  │  │  ├─ サービスアイコン（SVG）
│  │  │  ├─ タイトル
│  │  │  ├─ URL
│  │  │  └─ ステータス（成功/失敗）
│  │  └─ 履歴項目タップ
│  │      ├─ 簡易ログ表示
│  │      └─ 詳細ログ画面へのリンク
│  ├─ 設定タブ
│  │  ├─ 微振動 ON/OFF
│  │  ├─ 微振動強度（light/medium/heavy）
│  │  ├─ プログレスバー初期表示 ON/OFF
│  │  ├─ トースト通知 ON/OFF
│  │  ├─ トースト表示タイミング（分単位）
│  │  ├─ デフォルト解像度（リスト or 数字入力）
│  │  ├─ デフォルト形式 (音声/動画)
│  │  ├─ デフォルトフォーマット (リスト、 mp4/mkv/....・mp3/wav/m4a/....)
│  │  └─ デフォルト音声品質（44.1k/48k/96k/ロスレス）
│  └─ ダウンロードタブ
│      ├─ URL入力欄
│      ├─ ダウンロード開始ボタン
│      ├─ プログレスバー（Share Extension同等）
│      └─ 状態テキスト
└─ Share Extension
    ├─ 初期表示
    │  ├─ ダウンロード元のサービス名 / タイトル
    │  ├─ ダウンロード元のサービスアイコン（SVG）
    │  ├─ 形式(音声/動画)
    │  ├─ 解像度/フォーマット(任意、設定からデフォルトのフォーマットを変更可能)
    │  ├─ 状態テキスト（解析中/取得中/統合中）
    │  └─ プログレス表示ボタン（ユーザータップで表示）
    ├─ プログレス表示（ユーザータップ時）
    │  ├─ 進捗バー 0〜100%
    │  ├─ パーセンテージ表示
    │  └─ 微振動 2%ごと（設定でON/OFF・強度変更）
    ├─ トースト通知
    │  ├─ 5分経過 → 「長時間経過するとOSにより中断される可能性があります」
    │  └─ 8分経過 → 「まだダウンロード中です。OSにより中断される可能性があります」
    ├─ Quick Look
    │  ├─ 閲覧専用
    │  ├─ 保存/共有はQuick Look UIに任せる
    │  └─ 閉じたら tempファイル削除
    └─ エラー/中断
        ├─ ユーザー閉じ → kill & temp削除
        ├─ OS kill → 無言終了
        └─ yt-dlpエラー → トースト表示のみ